---
name: æ•´åˆæ¸¬è©¦èˆ‡ç«¯å°ç«¯é©—è­‰
status: open
created: 2025-12-09T09:13:21Z
updated: 2025-12-09T09:13:21Z
github: [Will be updated when synced to GitHub]
depends_on: [003, 005]
parallel: false
conflicts_with: []
---

# Task: æ•´åˆæ¸¬è©¦èˆ‡ç«¯å°ç«¯é©—è­‰

## Description
æ’°å¯«æ•´åˆæ¸¬è©¦èˆ‡ç«¯å°ç«¯æ¸¬è©¦ï¼Œé©—è­‰å¾æ¥æ”¶ LINE webhook åˆ°å›è¦†è¨Šæ¯çš„å®Œæ•´æµç¨‹ã€‚åŒ…å«æ­£å¸¸æƒ…å¢ƒã€éŒ¯èª¤æƒ…å¢ƒã€é‚Šç•Œæƒ…æ³çš„æ¸¬è©¦ï¼Œç¢ºä¿ç³»çµ±å„æ¨¡çµ„å”ä½œæ­£å¸¸ã€‚

## Acceptance Criteria
- [ ] `tests/test_integration/test_command_flow.py` å·²å»ºç«‹
- [ ] æ•´åˆæ¸¬è©¦ï¼šæŒ‡ä»¤è™•ç†å™¨ + çˆ¬èŸ²æ¨¡çµ„
- [ ] ç«¯å°ç«¯æ¸¬è©¦ï¼šwebhook + æŒ‡ä»¤è™•ç† + è¨Šæ¯å›è¦†ï¼ˆä½¿ç”¨ mock LINE APIï¼‰
- [ ] éŒ¯èª¤æƒ…å¢ƒæ¸¬è©¦ï¼šç¶²è·¯éŒ¯èª¤ã€çˆ¬å–å¤±æ•—ã€ç„¡æ–‡ç« 
- [ ] æ•ˆèƒ½æ¸¬è©¦ï¼šé©—è­‰å›æ‡‰æ™‚é–“ < 10 ç§’
- [ ] æ‰‹å‹•æ¸¬è©¦æª¢æŸ¥æ¸…å–®å·²åŸ·è¡Œä¸¦é€šé
- [ ] æ¸¬è©¦æ–‡ä»¶ï¼šè¨˜éŒ„æ¸¬è©¦çµæœèˆ‡ç™¼ç¾çš„å•é¡Œ

## Technical Details

### æ¸¬è©¦åˆ†é¡

#### 1. æ•´åˆæ¸¬è©¦ï¼ˆæŒ‡ä»¤è™•ç†å™¨ + çˆ¬èŸ²ï¼‰
```python
import pytest
from unittest.mock import Mock, AsyncMock
from src.handlers.command_handler import handle_aivi_command, format_news_message

@pytest.mark.asyncio
async def test_handle_aivi_command_success(mocker):
    """æ¸¬è©¦ /aivi æŒ‡ä»¤æˆåŠŸåŸ·è¡Œ"""
    # Mock LINE Bot API
    mock_line_bot_api = Mock()

    # Mock çˆ¬èŸ²å›å‚³è³‡æ–™
    mock_scrape = mocker.patch(
        'src.handlers.command_handler.scrape_aivi_news',
        new_callable=AsyncMock
    )
    mock_scrape.return_value = [
        {'title': 'Test Article 1', 'url': 'https://www.aivi.fyi/test-1'},
        {'title': 'Test Article 2', 'url': 'https://www.aivi.fyi/test-2'},
    ]

    # Mock event
    mock_event = Mock()
    mock_event.reply_token = 'test_token'

    # åŸ·è¡ŒæŒ‡ä»¤è™•ç†
    await handle_aivi_command(mock_event, mock_line_bot_api)

    # é©—è­‰ reply_message è¢«å‘¼å«
    assert mock_line_bot_api.reply_message.called
    call_args = mock_line_bot_api.reply_message.call_args
    message_text = call_args[0][1].text

    # é©—è­‰è¨Šæ¯æ ¼å¼
    assert 'ğŸ“° AIVI æœ€æ–°æ–‡ç« ' in message_text
    assert 'Test Article 1' in message_text
    assert 'https://www.aivi.fyi/test-1' in message_text

@pytest.mark.asyncio
async def test_handle_aivi_command_no_articles(mocker):
    """æ¸¬è©¦çˆ¬å–åˆ°ç©ºæ¸…å–®"""
    mock_line_bot_api = Mock()
    mock_scrape = mocker.patch(
        'src.handlers.command_handler.scrape_aivi_news',
        new_callable=AsyncMock
    )
    mock_scrape.return_value = []

    mock_event = Mock()
    mock_event.reply_token = 'test_token'

    await handle_aivi_command(mock_event, mock_line_bot_api)

    call_args = mock_line_bot_api.reply_message.call_args
    message_text = call_args[0][1].text
    assert 'ç›®å‰æ²’æœ‰æ‰¾åˆ°æ–°æ–‡ç« ' in message_text

@pytest.mark.asyncio
async def test_handle_aivi_command_scraper_error(mocker):
    """æ¸¬è©¦çˆ¬èŸ²æ‹‹å‡ºç•°å¸¸"""
    mock_line_bot_api = Mock()
    mock_scrape = mocker.patch(
        'src.handlers.command_handler.scrape_aivi_news',
        new_callable=AsyncMock
    )
    mock_scrape.side_effect = Exception("Network error")

    mock_event = Mock()
    mock_event.reply_token = 'test_token'

    await handle_aivi_command(mock_event, mock_line_bot_api)

    call_args = mock_line_bot_api.reply_message.call_args
    message_text = call_args[0][1].text
    assert 'âŒ' in message_text
    assert 'ç„¡æ³•å–å¾—æ–°è' in message_text
```

#### 2. è¨Šæ¯æ ¼å¼åŒ–æ¸¬è©¦
```python
def test_format_news_message_with_articles():
    """æ¸¬è©¦æ­£å¸¸æ–‡ç« æ ¼å¼åŒ–"""
    articles = [
        {'title': 'Article 1', 'url': 'https://example.com/1'},
        {'title': 'Article 2', 'url': 'https://example.com/2'},
    ]
    message = format_news_message(articles)

    assert 'ğŸ“° AIVI æœ€æ–°æ–‡ç« ' in message
    assert '1. Article 1' in message
    assert 'ğŸ”— https://example.com/1' in message
    assert '2. Article 2' in message

def test_format_news_message_empty():
    """æ¸¬è©¦ç©ºæ–‡ç« æ¸…å–®"""
    message = format_news_message([])
    assert 'ç›®å‰æ²’æœ‰æ‰¾åˆ°æ–°æ–‡ç« ' in message

def test_format_news_message_max_5_articles():
    """æ¸¬è©¦æœ€å¤šé¡¯ç¤º 5 å‰‡æ–‡ç« """
    articles = [
        {'title': f'Article {i}', 'url': f'https://example.com/{i}'}
        for i in range(10)
    ]
    message = format_news_message(articles)

    # é©—è­‰åªæœ‰ 5 å‰‡æ–‡ç« 
    assert '1. Article 0' in message
    assert '5. Article 4' in message
    assert '6. Article 5' not in message
```

#### 3. æ•ˆèƒ½æ¸¬è©¦ï¼ˆæ¨™è¨˜ç‚º slowï¼‰
```python
import time

@pytest.mark.slow
@pytest.mark.asyncio
async def test_command_response_time():
    """æ¸¬è©¦æŒ‡ä»¤å›æ‡‰æ™‚é–“ï¼ˆåƒ… CI åŸ·è¡Œï¼‰"""
    mock_line_bot_api = Mock()
    mock_event = Mock()
    mock_event.reply_token = 'test_token'

    start_time = time.time()
    await handle_aivi_command(mock_event, mock_line_bot_api)
    elapsed_time = time.time() - start_time

    # é©—è­‰å›æ‡‰æ™‚é–“ < 10 ç§’
    assert elapsed_time < 10, f"å›æ‡‰æ™‚é–“éé•·: {elapsed_time:.2f} ç§’"
```

### æ‰‹å‹•æ¸¬è©¦æª¢æŸ¥æ¸…å–®

åŸ·è¡Œä»¥ä¸‹æ¸¬è©¦ä¸¦è¨˜éŒ„çµæœï¼š

- [ ] **æ­£å¸¸æƒ…æ³**ï¼šåœ¨ LINE å‚³é€ `/aivi`ï¼Œæ”¶åˆ° 1-5 å‰‡æ–°è
- [ ] **å¤§å°å¯«æ¸¬è©¦**ï¼šæ¸¬è©¦ `/AIVI`ã€`/Aivi`ã€`/AiVi`
- [ ] **å‰å¾Œç©ºç™½**ï¼šæ¸¬è©¦ `  /aivi  `ï¼ˆå‰å¾Œæœ‰ç©ºç™½ï¼‰
- [ ] **éŒ¯èª¤æŒ‡ä»¤**ï¼šæ¸¬è©¦ `/aiv`ã€`/aivii`ï¼ˆä¸æ‡‰å›è¦†ï¼‰
- [ ] **é€£çµæ¸¬è©¦**ï¼šé»æ“Šå›è¦†ä¸­çš„é€£çµï¼Œç¢ºèªå¯é–‹å•Ÿæ­£ç¢ºé é¢
- [ ] **æ•ˆèƒ½æ¸¬è©¦**ï¼šæ¸¬é‡å¾å‚³é€åˆ°æ”¶åˆ°å›è¦†çš„æ™‚é–“ï¼ˆæ‡‰ < 10 ç§’ï¼‰
- [ ] **ç¶²è·¯éŒ¯èª¤æ¨¡æ“¬**ï¼šä¸­æ–·ç¶²è·¯ï¼Œå‚³é€ `/aivi`ï¼Œæª¢æŸ¥éŒ¯èª¤è¨Šæ¯

### æ¸¬è©¦æ–‡ä»¶ç¯„æœ¬

å»ºç«‹ `docs/test-results.md`ï¼š
```markdown
# æ¸¬è©¦çµæœè¨˜éŒ„

## æ¸¬è©¦æ—¥æœŸ
2025-12-09

## è‡ªå‹•åŒ–æ¸¬è©¦
- å–®å…ƒæ¸¬è©¦ï¼šé€šé (15/15)
- æ•´åˆæ¸¬è©¦ï¼šé€šé (8/8)
- è¦†è“‹ç‡ï¼š85%

## æ‰‹å‹•æ¸¬è©¦

### æ­£å¸¸æƒ…æ³
- ç‹€æ…‹ï¼šâœ… é€šé
- å›æ‡‰æ™‚é–“ï¼š3.5 ç§’
- å›å‚³æ–‡ç« æ•¸ï¼š5 å‰‡

### å¤§å°å¯«æ¸¬è©¦
- `/AIVI`ï¼šâœ… é€šé
- `/Aivi`ï¼šâœ… é€šé
- `/AiVi`ï¼šâœ… é€šé

### éŒ¯èª¤è™•ç†
- ç¶²è·¯éŒ¯èª¤ï¼šâœ… å›å‚³å‹å–„éŒ¯èª¤è¨Šæ¯
- ç„¡æ–‡ç« ï¼šâœ… å›å‚³ã€Œç›®å‰æ²’æœ‰æ‰¾åˆ°æ–°æ–‡ç« ã€

### ç™¼ç¾çš„å•é¡Œ
ï¼ˆè¨˜éŒ„æ¸¬è©¦ä¸­ç™¼ç¾çš„ä»»ä½•å•é¡Œï¼‰
```

## Dependencies
- [ ] Task 003 å®Œæˆï¼ˆçˆ¬èŸ²å–®å…ƒæ¸¬è©¦å·²å®Œæˆï¼‰
- [ ] Task 005 å®Œæˆï¼ˆæŒ‡ä»¤è™•ç†å™¨å·²å¯¦ä½œï¼‰
- [ ] LINE Channel å¯ç”¨æ–¼æ‰‹å‹•æ¸¬è©¦

## Effort Estimate
- Size: M
- Hours: 4
- Parallel: false

## Definition of Done
- [ ] `tests/test_integration/test_command_flow.py` å·²å»ºç«‹
- [ ] è‡³å°‘ 6 å€‹æ•´åˆæ¸¬è©¦æ¡ˆä¾‹
- [ ] æœ¬æ©ŸåŸ·è¡Œ `pytest -m "not slow"` é€šé
- [ ] æ‰‹å‹•æ¸¬è©¦æª¢æŸ¥æ¸…å–®å…¨éƒ¨å®Œæˆ
- [ ] `docs/test-results.md` å·²å»ºç«‹ä¸¦è¨˜éŒ„çµæœ
- [ ] æ•´é«”æ¸¬è©¦è¦†è“‹ç‡é” 80% ä»¥ä¸Š
- [ ] æ‰€æœ‰ç™¼ç¾çš„å•é¡Œå·²ä¿®å¾©æˆ–è¨˜éŒ„
