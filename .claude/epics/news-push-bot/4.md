---
name: AIVI 爬蟲模組單元測試
status: completed
created: 2025-12-09T09:13:21Z
updated: 2025-12-09T10:15:00Z
github: https://github.com/btisland/aivi-linebot/issues/4
depends_on: [3]
parallel: false
conflicts_with: []
---

# Task: AIVI 爬蟲模組單元測試

## Description
為 AIVI 爬蟲模組撰寫完整的單元測試，使用 mock 技術模擬 HTTP 回應，測試各種情境（正常、錯誤、邊界情況）。分為快速測試（本機）和慢速測試（CI），確保測試覆蓋率達標。

## Acceptance Criteria
- [ ] `tests/test_scrapers/test_aivi_scraper.py` 已建立
- [ ] 正常情況測試：mock 正常 HTML，驗證解析結果
- [ ] 邊界情況測試：空 HTML、無文章、少於 5 篇文章
- [ ] 錯誤處理測試：網路錯誤、HTTP 錯誤、解析錯誤
- [ ] 相對路徑處理測試：驗證 URL 前綴正確加上
- [ ] 快速測試（本機可執行）：使用 mock，不發送真實請求
- [ ] 慢速測試（僅 CI）：標記 `@pytest.mark.slow`，發送真實網路請求
- [ ] 測試覆蓋率：爬蟲模組達 80% 以上

## Technical Details

### 測試分類

#### 快速單元測試（本機 + CI）
```python
def test_parse_articles_normal():
    """測試正常 HTML 解析"""
    html = '''
    <h2 class="archive__item-title"><a href="/article-1">Title 1</a></h2>
    <h2 class="archive__item-title"><a href="/article-2">Title 2</a></h2>
    '''
    articles = parse_articles(html, max_articles=5)
    assert len(articles) == 2
    assert articles[0]['title'] == 'Title 1'
    assert articles[0]['url'] == 'https://www.aivi.fyi/article-1'

def test_parse_articles_empty():
    """測試空 HTML"""
    articles = parse_articles("")
    assert articles == []

def test_parse_articles_no_articles():
    """測試找不到文章元素"""
    html = "<div>No articles here</div>"
    articles = parse_articles(html)
    assert articles == []

@pytest.mark.asyncio
async def test_scrape_aivi_news_http_error(mocker):
    """測試 HTTP 錯誤處理"""
    mock_get = mocker.patch('httpx.AsyncClient.get')
    mock_get.side_effect = httpx.HTTPError("Network error")

    articles = await scrape_aivi_news()
    assert articles == []
```

#### 慢速測試（僅 CI，標記 @pytest.mark.slow）
```python
@pytest.mark.slow
@pytest.mark.asyncio
async def test_real_aivi_website_scraping():
    """實際連線測試 AIVI 網站（僅 CI 執行）"""
    articles = await scrape_aivi_news()
    assert len(articles) > 0
    assert all('title' in a and 'url' in a for a in articles)
    assert all(a['url'].startswith('https://') for a in articles)
```

### 測試工具
- **pytest**: 測試框架
- **pytest-asyncio**: 非同步測試支援
- **pytest-mock**: Mock 工具
- **pytest-cov**: 覆蓋率分析（僅 CI）

### pytest.ini 設定
```ini
[tool.pytest.ini_options]
markers = [
    "slow: marks tests as slow (deselect with '-m \"not slow\"')",
]
```

### 本機測試指令
```bash
# 執行快速測試（排除 slow）
pytest -m "not slow" tests/test_scrapers/

# 執行特定測試
pytest tests/test_scrapers/test_aivi_scraper.py::test_parse_articles_normal
```

### CI 測試指令
```bash
# 執行所有測試（包括 slow）+ coverage
pytest --cov=src/scrapers --cov-report=term
```

## Dependencies
- [ ] Task 002 完成（爬蟲模組已實作）
- [ ] pytest 套件已安裝
- [ ] pytest-asyncio 套件已安裝
- [ ] pytest-mock 套件已安裝

## Effort Estimate
- Size: M
- Hours: 3
- Parallel: false

## Definition of Done
- [ ] `tests/test_scrapers/test_aivi_scraper.py` 已建立
- [ ] 至少 8 個測試案例
- [ ] 本機執行 `pytest -m "not slow"` 通過
- [ ] Mock 測試不發送真實網路請求
- [ ] 測試函式都有清楚的繁體中文 docstring
- [ ] 測試覆蓋爬蟲模組所有公開函式
