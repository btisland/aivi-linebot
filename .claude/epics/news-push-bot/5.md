---
name: LINE Bot Webhook 服務建立
status: open
created: 2025-12-09T09:13:21Z
updated: 2025-12-09T09:24:52Z
github: https://github.com/btisland/aivi-linebot/issues/5
depends_on: [001]
parallel: true
conflicts_with: []
---

# Task: LINE Bot Webhook 服務建立

## Description
建立 LINE Bot 的 webhook 服務，使用 Flask 框架接收 LINE 平台的事件通知，實作簽章驗證、事件解析，並建立基本的訊息回覆機制。這是 LINE Bot 的核心入口。

## Acceptance Criteria
- [ ] `src/app.py` 已建立（Flask 應用程式入口）
- [ ] 實作 `POST /webhook` endpoint
- [ ] 實作 LINE 簽章驗證（使用 LINE_CHANNEL_SECRET）
- [ ] 實作事件類型解析（MessageEvent）
- [ ] 實作訊息類型檢查（TextMessageContent）
- [ ] 建立 LineBotApi 與 WebhookHandler 實例
- [ ] 環境變數載入機制（LINE_CHANNEL_SECRET, LINE_CHANNEL_ACCESS_TOKEN）
- [ ] 錯誤處理：簽章驗證失敗、無效的請求
- [ ] 本機開發模式：可使用 ngrok 測試

## Technical Details

### Flask 應用程式結構

```python
from flask import Flask, request, abort
from linebot import LineBotApi, WebhookHandler
from linebot.exceptions import InvalidSignatureError
from linebot.models import MessageEvent, TextMessageContent
import os

app = Flask(__name__)

# 從環境變數載入 LINE credentials
line_bot_api = LineBotApi(os.getenv('LINE_CHANNEL_ACCESS_TOKEN'))
handler = WebhookHandler(os.getenv('LINE_CHANNEL_SECRET'))

@app.route("/webhook", methods=['POST'])
def webhook():
    """LINE Bot webhook endpoint"""
    # 取得 X-Line-Signature header
    signature = request.headers.get('X-Line-Signature')
    if not signature:
        abort(400)

    # 取得 request body
    body = request.get_data(as_text=True)

    # 驗證簽章並處理事件
    try:
        handler.handle(body, signature)
    except InvalidSignatureError:
        abort(400)

    return 'OK'

@handler.add(MessageEvent, message=TextMessageContent)
def handle_message(event):
    """處理文字訊息事件"""
    # 將在 Task 005 實作指令處理邏輯
    pass

if __name__ == "__main__":
    port = int(os.getenv('PORT', 5000))
    app.run(host='0.0.0.0', port=port, debug=True)
```

### 環境變數設定
確保 `.env` 檔案包含：
```bash
LINE_CHANNEL_SECRET=your_channel_secret
LINE_CHANNEL_ACCESS_TOKEN=your_access_token
PORT=5000
```

### 本機測試流程

#### 1. 啟動 Flask 服務
```bash
source .venv/bin/activate
python src/app.py
```

#### 2. 使用 ngrok 建立 HTTPS tunnel
```bash
ngrok http 5000
```

#### 3. 設定 LINE Webhook URL
在 LINE Developers Console 設定：
```
https://your-ngrok-url.ngrok.io/webhook
```

#### 4. 測試
在 LINE 傳送訊息，檢查 Flask log 是否收到事件

### 錯誤處理

| 錯誤情況 | HTTP 狀態碼 | 處理方式 |
|---------|------------|---------|
| 無 X-Line-Signature header | 400 | abort(400) |
| 簽章驗證失敗 | 400 | abort(400) |
| 其他異常 | 500 | 記錄錯誤日誌 |

### 日誌設定
```python
import logging

logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
)
logger = logging.getLogger(__name__)
```

## Dependencies
- [ ] Task 001 完成（套件已安裝）
- [ ] line-bot-sdk 套件可用
- [ ] flask 套件可用
- [ ] 已取得 LINE Channel Secret 和 Access Token
- [ ] 本機測試需要 ngrok

## Effort Estimate
- Size: M
- Hours: 3
- Parallel: true

## Definition of Done
- [ ] `src/app.py` 已建立
- [ ] `/webhook` endpoint 可接收 POST 請求
- [ ] 簽章驗證邏輯正確
- [ ] 環境變數正確載入
- [ ] 本機啟動服務無錯誤
- [ ] 使用 ngrok + LINE 實測可收到事件
- [ ] 程式碼包含完整的繁體中文註解
- [ ] 錯誤處理邏輯完整
